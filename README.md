# Centauri Carbon Motion Detector

## What it does

- Watches a BigTreeTech filament motion sensor that sits in the filament path.
- Listens to your OpenCentauri-enabled Centauri Carbon over LAN wia websocket to determine how much filament should be moving.
- Compares the expected data with the actual output of the BTT SFS, and uses multiple algorithms to determine different failure states (filament stop, partial clog, severe underextrusion).  This data and analysis allows for slow first layers, ironing, large travel moves, very slow print speeds, pauses etc. to occur without triggering a false positive.
- Hosts a lightweight dashboard on the ESP32 so you can check status, tweak settings, grab logs, and load new firmware from any browser.

## What you need before you start

- BigTreeTech filament motion sensor (SFS-style) installed in the filament line.
- ESP32 (or another board listed in `platformio.ini`) plus USB-C cable.
- If you would like to customize or build your own firmware - an environment with Python 3.10+ and Node.js 18+. The quick-start scripts confirm the versions for you.

## Setup at a glance

1. Plug the ESP32 into your computer.
2. Download and flash the appropriate firmware for your board.  Online flash tools or CLI/VSCode etc all work
3. Mount and wire the sensor to the ESP32 (or board of your choice).  Use the pins specified for your specific board in platformio.ini.
4. Attach the sensor, power up the ESP32, and connect via a Wifi-enabled device.  Provide Wifi credentials.
5. Reboot, reconnect, and configure settings.

## Step-by-step setup

### 1. Flash firmware onto the ESP32

- Connect the board to your computer over USB-C.
- Use your preferred flashing method (online WebSerial tool, VS Code + PlatformIO, or CLI) to load the `firmware_merged_####.bin` that matches your board definition.
- Wait for the flashing process to finish and confirm the board reboots cleanly.

### 2. Give the device your Wifi info through its access point

- With the sensor attached, power cycle the ESP32 so it starts broadcasting `CentauriCarbon.local`.
- Connect to that temporary Wifi from any phone, tablet, or computer.
- Visit `http://centaurifilament.local`, open the Settings tab, and enter your home SSID plus password.
- Scroll down, select Save Settings, and allow the automatic reboot. The ESP32 drops the temporary network and joins your main Wifi instead.

### 3. Prepare the hardware

- Install the BigTreeTech sensor in the filament path so the filament slides smoothly through the gears.
- Power the sensor via 3v3 and GND from the ESP32.  (The sensor can optionally be connected directly to the filament detector wires provided by the CC - at this time, instructions are not provided for this implementation.  Use at your own risk.)  Wire the sensor leads to the ESP32 pins that match your board's entry in `platformio.ini`.

### 4. Reconnect over your LAN

- Back on your normal Wifi, browse to `http://centaurifilament.local`. The About tab lists the current IP address if you prefer connecting directly.
- Power the board from a reliable USB source - cheap power bricks can and will cause failures.

### 5. First run checklist

- Confirm the dashboard loads at `http://centaurifilament.local` and the Status tab shows telemetry within a few seconds.
- Start a small print. You should see pulse counts updating and the state remain on "Monitoring."
- If you need the raw IP address for future logins, grab it from the About tab before you close the page.

## Dashboard

The ESP32 serves a single-page site with tabs along the top. Each tab has a clear job:

- **Status**: Real-time view of filament flow, jam warnings, and recent activity. Use this tab while printing.
- **Settings**: Wifi, printer connection, and detection settings. After changing anything, select Save Settings and wait for the confirmation.
- **Logs**: Shows the most recent lines from the firmware log. Download the full (last 1024 entries) text file for troubleshooting.
- **Update**: Drag-and-drop a `firmware.bin` file generated by PlatformIO or click to browse for it. The ESP32 reboots automatically once the upload finishes.
- **About**: Device information such as firmware version, build date, Wifi status, IP, and free memory. Helpful when confirming which image is currently installed.

## Dev - Data overview

- `data/` contains everything that ships with the ESP32 flash image:
  - `data/user_settings.json` and `data/user_settings.secrets.json` (described above).
  - `data/default_settings.json` includes safe defaults. The firmware copies these into your live settings on first boot.
  - `data/webui/` (generated from `webui_lite/`) holds the HTML, CSS, and JavaScript for the dashboard.
- `logs/` stores diagnostic files pulled from the device. Live logs are also accessible through the web interface via `/api/logs_live` or `/api/logs_text`.
- `.pio/` is PlatformIO's build output. You can ignore it unless you are rebuilding firmware manually.

## Dev - firmware and littleFS updates

- Rebuilding with `quick-start.bat` or `./quick-start.sh` always delivers the latest Lite UI and firmware combination.
- For smaller updates, open the Update tab and upload the new `firmware.bin` that PlatformIO produced in `.pio/build/<board>/`.
- The About tab lists both the firmware and filesystem thumbprints so you know exactly what is running before and after an update.

## Troubleshooting basics

- If the dashboard never loads, confirm the ESP32 LED is on and the board is still connected to Wifi. A quick reboot often fixes it.
- If Status shows "No telemetry," verify the printer IP address in Settings and ensure the printer is powered on.
- If you get frequent false pauses, raise the soft jam time slider slightly or run a short extrusion test to ensure the sensor wheel is free of dust.
- Open an issue if the above do not resolve the issue.

## License

See [LICENSE.MD](LICENSE.MD).

## Credits

- OpenCentauri team for enabling the firmware patches required to access filament extrusion data
- jrowny for the initial idea and starting point
